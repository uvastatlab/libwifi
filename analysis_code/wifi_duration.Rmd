---
title: "WiFi User Duration"
author: "StatLab: Margot Bjoring, Michele Claibourn"
date: "Fall 2019"
output: 
  html_document:
    toc: true
    toc_depth: 4
---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, fig.align='center', message = FALSE)
```

```{r}
library(tidyverse)
library(lubridate)
library(anytime)
library(plotly)
library(knitr)
library(scales)
library(readxl)
```

```{r cache=TRUE}
spells <- read_csv('../spells/spells.csv')
users <- read_csv('../WiFi_data/useraffil.csv')
gatecount <- read_excel("../WiFi_data/2018gate-counts.xlsx", sheet = 1)
```

```{r}
# prep data
spells <- left_join(spells, users, by="user")
spells <- spells %>% mutate(affiliation = as.factor(affiliation))

gatecount <- gatecount %>%
  select(-location) %>%
  rename(gatecount=visitors, location=name) %>%
  mutate(location = recode(location, 
                           `ALD LIB` = "alderman",
                           `CLEM LIB` = "clemons",
                           `Harrison Small` = "harrison"),
         date = as.Date(date))
```

```{r}
# add fall, spring dummies
spells <- spells %>% 
  mutate(spring = ifelse(date >= anydate("01/17/2018") & date <= anydate("05/11/2018"), 1, 0),
         fall = ifelse(date >= anydate("08/28/2018") & date <= anydate("12/18/2018"), 1, 0))

se <- function(x) sqrt(var(x)/length(x))
```

## Duration of Connections
We approximate the length of a visit by summing the number of consecutive half-hour increments in which a user is connected to the library wifi in a given location. 

```{r}
# Without affiliations: ----
# 1. Overall distribution of spells
# 1a. Table 
spells %>% group_by(location) %>% 
  summarize(min_length = min(maxstay), mean_length = mean(maxstay),
            med_length = median(maxstay), max_length = max(maxstay)) %>% 
  kable(col.names = c("Location", "Min Stay", "Mean Stay", "Median Stay", "Max Stay"), 
        align = c("l", "c", "c", "c", "c"))
```

The maximum lengths capture devices that are fixed in the buildings and remain nearly continuously connected. Because of these outliers, the median length may be a better representation of the typical duration of a visit.

## Distribution of connection length
```{r}
# 1b. Figure: for stays under 12 hours
p <- spells %>% 
  group_by(location, maxstay) %>%
  filter(maxstay < 12) %>%
  summarize(count = n()) %>%
  ggplot() + 
  geom_bar(aes(x = maxstay, y = count, fill = location), stat = "identity") + 
  facet_grid(cols = vars(location)) +
  xlab("Stay lengths") +
  ylab("Number of visits") +
  ggtitle("Distribution of stay lengths (among visits < 12 hours)")
ggplotly(p)
```
Alderman experiences a high number of half-hour visits generated by drop-ins to pick up materials at the desk or to buy coffee, as well as walk-bys -- connections made by individuals outside of the building or passing by.

## Connection length across time

```{r}
# 2. Distribution across year 
p <- spells %>%
  group_by(location, date) %>%
  filter(maxstay < 50) %>%
  summarize(medstay = median(maxstay), meanstay = round(mean(maxstay), 2)) %>%
  ggplot() + 
  geom_line(aes(x = date, y = medstay), alpha = 0.5) + 
  geom_line(aes(x = date, y = meanstay, color = location)) + 
  facet_grid(rows = vars(location)) +
  xlab("Date") +
  ylab("Mean (color) and median (black) stay length") +
  ggtitle("Average/Median Connection Length over Time (among visits <50 hrs)")
ggplotly(p)
```

## Connection length by day of week

```{r}
# 3. Distribution across week
p <- spells %>%
  mutate(weekday = wday(time, week_start = 1)) %>%
  group_by(location, weekday) %>%
  filter(maxstay < 50 & fall == 1 | spring == 1) %>%
  summarize(medstay = median(maxstay), 
            meanstay = round(mean(maxstay), 2),
            sdstay = sd(maxstay)) %>% 
  ggplot() + 
  geom_line(aes(x = weekday, y = meanstay, color = location)) +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7), 
                     labels = c("Mon","Tues","Wed","Thurs","Fri","Sat","Sun")) + 
  xlab("Weekdays") +
  ylab("Mean stay length") +
  ggtitle("Average Connection Length across Weekdays (among visits <50 hrs)")
ggplotly(p)
```

## Half-hour connections across time

```{r}
p <- spells %>% 
  filter(maxstay == 0.5) %>%
  group_by(location, date) %>%
  summarize(count = n()) %>%
  ggplot() + 
  geom_bar(aes(x = date, y = count, fill = location), stat = "identity") + 
  facet_grid(rows = vars(location)) +
  xlab("Date") +
  ylab("Number of visits") +
  ggtitle("Frequency of half-hour visits")
ggplotly(p)
```

## Half-hour connections by time of day

```{r}
p <- spells %>% 
  filter(maxstay == 0.5) %>%
  mutate(hour = hour(time)) %>%
  group_by(location, hour) %>%
  summarize(count = n()) %>%
  ggplot() + 
  geom_bar(aes(x = hour, y = count, fill = location), stat = "identity") + 
  facet_grid(rows = vars(location)) +
  scale_x_continuous(breaks=c(0,6,12,18,24),labels=c("00:00","06:00","12:00","18:00","24:00")) +
  xlab("Time of Day") +
  ylab("Number of visits") +
  ggtitle("Distribution of half hour visits")
ggplotly(p)
```

## Connection Length by Affiliation

```{r}
# Average stay by affiliation/loation
# take 2 for plotly - maybe fix tooltip labels
p <- spells %>%
  group_by(location, affiliation) %>%
  summarize(stay = round(mean(maxstay), 2),
            stayse = se(maxstay)) %>%
  ungroup() %>%
  ggplot(aes(x = affiliation, y = stay, ymin = stay-stayse, ymax = stay+stayse, fill = location)) +
  geom_bar(stat="identity", position="dodge") +
  geom_errorbar(position = "dodge") +
  xlab("Affiliation") +
  ylab("Stay length") +
  ggtitle("Average connection length by affiliation")
ggplotly(p)
```
User affiliation (student, faculty, staff, etc.) is captured as described previously.


## Number of visits by location
The following tables and figures examine the number of unique visits -- as approximated by a consecutively-connected user. Here, the same user can represent multiple visits given multiple nonconsecutive connections in a given time period.

```{r}
# Number of visits (non-consecutive connections; not visitors) by location
spells %>% group_by(location) %>% count() %>% 
  kable(col.names = c("Location", "Number of Visits"), align = c("l", "c"))
```

## Number of visits across time

```{r}
# Number of visits by location, date
p <- spells %>% group_by(location, date) %>% summarize(n = n()) %>% 
  ggplot(aes(x = date, y = n, color = location)) + geom_line() +
  xlab("Date") + ylab("Number of visits") + ggtitle("Number of Visits by Day")
ggplotly(p)
```

## Gatecount Comparison: Alderman

```{r}
# Number of visits by location, date
visits <- spells %>% group_by(location, date) %>% summarize(wifi = n()) %>% ungroup()
visits <- visits %>% left_join(gatecount, by = c("location", "date"))
visits <- pivot_longer(visits, -c(location, date), values_to = "n", names_to = "source")

p <- visits %>% filter(location == "alderman") %>% 
  ggplot(aes(x = date, y = n, color = source)) + geom_line()+ 
  xlab("Date") + ylab("Number of visits") + ggtitle("Number of Visits to Alderman by Day: Wifi vs. Gatecount")
ggplotly(p)
```

## Gatecount Comparison: Clemons

```{r}
p <- visits %>% filter(location == "clemons") %>% 
  ggplot(aes(x = date, y = n, color = source)) + geom_line()+ 
  xlab("Date") + ylab("Number of visits") + ggtitle("Number of Visits to Clemons by Day: Wifi vs. Gatecount")
ggplotly(p)
```

## Gatecount Comparison: Harrison-Small

```{r}
p <- visits %>% filter(location == "harrison") %>% 
  ggplot(aes(x = date, y = n, color = source)) + geom_line()+ 
  xlab("Date") + ylab("Number of visits") + ggtitle("Number of Visits to Harrison-Small by Day: Wifi vs. Gatecount")
ggplotly(p)
```

## Number of visits by affiliation

```{r}
# Number of visits by location, affiliation throughout 2018
spells %>% group_by(location, affiliation) %>% count() %>% 
  pivot_wider(names_from = "location", values_from = "n") %>% 
  kable(col.names = c("Affiliation", "Alderman", "Clemons", "Harrison-Small"),
                      align = c("l", "c", "c", "c"))
```

## Average visits by affiliation

```{r}
# average number of visits by unique user by affiliation, location
p <- spells %>% 
  group_by(location, affiliation, user) %>% 
  summarize(visits = n()) %>%
  summarize(avgvisits = round(mean(visits), 2)) %>%
  ggplot() +
  geom_bar(aes(x = affiliation, y = avgvisits, fill = location), stat="identity", position="dodge") +
  xlab("Affiliation") + ylab("Mean number of visits") + ggtitle("Average Number of Visits among Users by Affiliation")
ggplotly(p)
```
This represents the average number of visits made by indiviudal users within an affiliation type; e.g., for each student who visited, we've summed the number of distinct visits. Among students who visited a library, they averaged 47 visits to Alderman, 20 to Clemons, and 10 to Harrison-Small.